<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Application UI</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
     
    <!-- Link JavaScript file -->
    <script src="{{ url_for('static', filename='chat_js/landing_page.js') }}"></script>
    <script src="{{ url_for('static', filename='chat_js/group_chat.js') }}"></script>
    <script src="{{ url_for('static', filename='chat_js/fetch_msg.js') }}"></script>
    <script src="{{ url_for('static', filename='chat_js/profile.js') }}"></script>

    <!-- Link CSS file -->
    <link rel="stylesheet" href="{{ url_for('static', filename='chat_css/chat.css') }}">

    <!-- Include Font Awesome for the icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

</head>

<style>
    .date-separator {
    align-items: center;
    width: fit-content;
    text-align: center;
    margin: 10px auto; /* Centers the div */
    font-size: 12px;
    color: #494949;
    font-weight: bold;
    background: #e2e2e2;
    padding: 5px 10px;
    display: inline-block;
    border-radius: 10px;
}

.message-time {
    font-size: 10px;
    color: gray;
    text-align: right;
    margin-top: 5px;
}


</style>


<body>
    <div class="chat-container">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <h4>Chat App</h4>
            <button type="button" class="btn btn-primary w-100 mb-2" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                + Create Group
            </button>
            
            
    <!-- Personal Chats -->
    {% if personal_chats %}      
        <ul class="list-group" id="personalChats">
            <div class="personal-chats-container">
                <i class="fas fa-user-friends"></i> 
                <h6 class="personal-chats-heading"><strong>Personal Chats</strong></h6>
                <div class="line"></div>
            </div>
            {% for chat in personal_chats %}
            <li class="list-group-item bg-transparent text-white d-flex align-items-center" 
                onclick="openPersonalChat('{{ chat.receiver_id }}', '{{ chat.receiver_name }}', '{{ chat.receiver_role }}','{{chat.receiver_contact}}')">
                
                <!-- User Profile Image -->
                <img src="{{ url_for('static', filename='images/' + (chat.receiver_image if chat.receiver_image else 'admin.jpg')) }}" 
                    alt="Profile Image" 
                    class="rounded-circle me-2" 
                    style="width: 35px; height: 35px; object-fit: cover; cursor: pointer;"
                    onclick="viewUserProfile(event, '{{ chat.receiver_id }}', '{{ chat.receiver_name }}', '{{ chat.receiver_email }}', '{{ chat.receiver_role }}', '{{ chat.receiver_contact }}')">
                
                {{ chat.receiver_name }}

            </li>
            
            {% endfor %}
        </ul>
    {% endif %}

<!-- Group Chats -->
{% if group_chats %}
<div class="personal-chats-container">
    <i class="fas fa-users"></i>
    <h6 class="personal-chats-heading"><strong>Group Chats</strong></h6>
    <div class="line"></div>
</div>
<ul class="list-group" id="groupChats">
    {% for chat in group_chats %}
    <li class="list-group-item bg-transparent text-white d-flex align-items-center" 
        onclick="openGroupChat('{{ chat.group_id }}', '{{ chat.receiver_name }}')">
        
        <!-- Group Image -->
        <img src="{{ url_for('static', filename='images/' + (chat.group_image if chat.group_image else 'admin.png')) }}" 
             alt="Group Image" 
             class="rounded-circle me-2" 
             style="width: 35px; height: 35px; object-fit: cover; cursor: pointer;"
             onclick="viewUserProfile(event, '{{ chat.group_id }}', '{{ chat.receiver_name }}', '', 'Group', '')">
        
        {{ chat.receiver_name }}
        
    </li>
    {% endfor %}
</ul>
{% endif %}


        </div>

        <!-- Right Chat Window -->
        <div class="chat-window" id="chatWindow">
 <!-- User Profile and Search Bar -->
<div class="d-flex align-items-center justify-content-between position-relative">
<!-- Search Bar with Search Icon -->
<div class="chat-search flex-grow-1 position-relative">
    <div class="position-relative">
        <i class="fas fa-search position-absolute text-muted" 
           style="left: 20px; top: 50%; transform: translateY(-50%);"></i>

        <!-- Search Input -->
        <input type="text" class="form-control ps-5" id="searchUser" placeholder="Search user...">
    </div>

    <!-- Search Results Dropdown -->
    <div id="searchResults" class="list-group position-absolute bg-white shadow-sm" 
         style="z-index:1000;width: 80%;margin-left: px;"></div>
</div>



                <!-- User Profile Image -->
                <img src="static/images/admin.jpg" 
                    alt="User Profile" 
                    class="rounded-circle ms-2" 
                    style="width: 40px; height: 40px; object-fit: cover; cursor: pointer; margin-right: 20px; margin-top: 10px;"
                    onclick="toggleUserSidebar()">
            </div>

            <!-- Sidebar for User Profile (Initially Hidden) -->
            <div id="userSidebar" class="position-fixed top-0 end-0 bg-white shadow-lg p-4" 
                style="width: 300px; height: 100vh; transform: translateX(100%); transition: transform 0.3s ease-in-out;">
                
                <!-- Close Button -->
                <button class="btn-close position-absolute top-0 end-0 m-3" onclick="toggleUserSidebar()"></button>

                <!-- User Profile Details -->
                <div class="text-center mt-4">
                    <img src="static/images/admin.jpg" 
                        alt="User Profile" 
                        class="rounded-circle mb-3" 
                        style="width: 80px; height: 80px; object-fit: cover;">
                    
                    <h5></h5>
                    <p class="text-muted"></p>
                    <p class="text-muted"></p>
                </div>
            </div>

            <div class="chat-header">
                <h5 id="chatTitle" onclick="openEditGroupModal()"
        style="cursor: pointer;">Select a Chat</h5>
            </div>
            <div class="chat-body" id="chatBody">
                <p class="text-muted text-center">No chat selected.</p>
            </div>
            
            <!-- Floating notification -->
            <div id="newMessagePopup" style="display:none;">  
                New Messages
                
            </div>
            <div class="chat-footer">
                <input type="text" class="form-control" id="messageInput" placeholder="Type a message...">
                <button class="btn btn-primary" id="sendMessage"><i class="fa fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

 <!-- Modal -->
<div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="height: 80vh;"> <!-- Fixed height -->
            <div class="modal-header">
                <i class="fas fa-users"></i>
                <h5 class="modal-title" style="margin-left: 10px;"><strong>Create New Group</strong></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="overflow-y: auto; max-height: calc(100% - 60px - 56px);"> <!-- Scrollable body -->
                <form id="createGroupForm">
                    <div class="mb-3">
                        <label for="groupName" class="form-label">Group Name</label>
                        <input type="text" class="form-control" id="groupName" placeholder="Enter group name" required>
                    </div>
                    <div class="mb-3">
                        <label for="groupDescription" class="form-label">Group Description</label>
                        <textarea class="form-control" id="groupDescription" rows="3" placeholder="Enter group description"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Selected Members</label>
                        
                                <div id="selectedMembers">
                            
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="groupMembers" class="form-label">Add Members</label>
                        <div class="row">
                            {% for user in all_users %}
                            <div class="col-md-4">
                                <div class="card shadow-sm border-0 mb-2">
                                    <div class="card-body d-flex justify-content-between align-items-center p-2">
                                        <div>
                                            <span class="fw-bold">{{ user.name }}</span><br>
                                            <small class="text-muted">{{ user.role }}</small><br>
                                            <small class="text-muted">{{ user.contact }}</small> <!-- Show mobile number -->
                                        </div>
                                        <button type="button" class="btn btn-primary btn-sm add-user-btn" 
                                            data-user-id="{{ user.id }}" 
                                            data-user-name="{{ user.name }}"
                                            data-user-mobile="{{ user.contact }}" 
                                            data-user-role="{{ user.role }}">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}

                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="position: absolute; bottom: 0; width: 100%; background: white;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button id="createGroupBtn" class="btn btn-primary">Create Group</button>

            </div>
        </div>
    </div>
</div>


<!-- User Profile Modal -->
<div class="modal fade" id="userProfileModal" tabindex="-1" aria-labelledby="userProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><strong>User Profile</strong></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="profilePicture" src="https://via.placeholder.com/100" class="rounded-circle mb-3" alt="Profile Picture">
                <h5 id="profileName"></h5>
                <p id="profileRole" class="text-muted"></p>
                <p><strong>Email:</strong> <span id="profileEmail"></span></p>
                <p><strong>Contact:</strong> <span id="profileContact"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>



<!-- Group Edit Modal -->
<div class="modal fade" id="editGroupModal" tabindex="-1" aria-labelledby="editGroupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="height: 80vh;">
            <div class="modal-header">
                <h5 class="modal-title" id="editGroupModalLabel">Edit Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="overflow-y: auto; max-height: calc(100% - 60px - 56px);">
                <form id="editGroupForm">
                    <input type="hidden" id="groupId" name="group_id">

                    <!-- Group Name -->
                    <div class="mb-3">
                        <label for="groupNamemodel" class="form-label">Group Name</label>
                        <input type="text" class="form-control" id="groupNamemodel" name="group_name">
                    </div>

                    <!-- Group Description -->
                    <div class="mb-3">
                        <label for="groupDescriptionmodel" class="form-label">Group Description</label>
                        <textarea class="form-control" id="groupDescriptionmodel" name="group_description" rows="3"></textarea>
                    </div>

                    <!-- Participants Grid -->
                    <div class="mb-3">
                        <label for="groupParticipantsContainer" class="form-label">Participants</label>
                        <div class="container">
                            <div class="row" id="groupParticipantsContainer"></div> <!-- Members will be added here -->
                        </div>
                    </div>

                    <!-- Add Members Button -->
                    <button type="button" class="btn btn-primary mt-2" onclick="showAddMembers()">Add Members +</button>

                    <!-- Add Members Section -->
                    <div id="addMembersSection" style="display: none;">
                        <label class="form-label"></label>
                        <div id="availableUsersContainer"></div> <!-- Users will be displayed here -->
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="saveGroupChanges()">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>

    
// Handle Group Chat Selection
document.querySelectorAll('.group-chat').forEach(group => {
    group.addEventListener('click', function () {
        let chatWindow = document.getElementById("chatWindow");
        chatWindow.setAttribute("data-group-id", this.getAttribute('data-group-id')); // Set Group ID
        chatWindow.removeAttribute("data-user-id"); // Remove personal chat ID
        chatWindow.removeAttribute("data-user-role"); // Remove user role (not needed in group chat)

        console.log("Group Chat Selected");
        console.log("Group ID:", this.getAttribute('data-group-id'));
    });
});

// Handle Personal Chat Selection
document.querySelectorAll('.personal-chat').forEach(user => {
    user.addEventListener('click', function () {
        let chatWindow = document.getElementById('chatWindow');
        chatWindow.setAttribute('data-user-id', this.getAttribute('data-user-id')); // Set user ID
        chatWindow.setAttribute('data-user-role', this.getAttribute('data-user-role')); // Set user role
        chatWindow.removeAttribute("data-group-id"); // Remove group ID (not needed in personal chat)

        console.log("Personal Chat Selected");
        console.log("Receiver ID:", this.getAttribute('data-user-id'));
        console.log("Receiver Role:", this.getAttribute('data-user-role'));
    });
});

// Handle Sending Messages
document.getElementById("sendMessage").addEventListener("click", function () {
    let messageInput = document.getElementById("messageInput");
    let messageText = messageInput.value.trim();
    let chatWindow = document.getElementById("chatWindow");

    let groupId = chatWindow.getAttribute("data-group-id");  // Group chat ID
    let receiverId = chatWindow.getAttribute("data-user-id");  // Personal chat ID
    let receiverRole = chatWindow.getAttribute("data-user-role"); // Receiver Role (for personal chat)

    console.log("Selected Group ID:", groupId);
    console.log("Selected Receiver ID:", receiverId);
    console.log("Message Text:", messageText);

    if (!messageText) {
        alert("Please enter a message before sending.");
        return;
    }

    if (!groupId && !receiverId) {
        alert("No chat selected.");
        return;
    }

    // Prepare request payload
    let requestData = { message: messageText };

    if (groupId) {
    requestData.receiver_id = groupId; // Use receiver_id for group
    requestData.receiver_role = null; // Ensure role is null for group chats
    } else if (receiverId) {
        requestData.receiver_id = receiverId; // Personal chat
        if (receiverRole) {
            requestData.receiver_role = receiverRole;
        }
    }

    console.log("Sending message:", requestData);

    fetch("/chat/send_message", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        console.log("Server Response:", data);

        if (data.error) {
            console.error("Error from server:", data.error);
            alert("Error sending message: " + data.error);
            return;
        }

        if (data.message) {
            let chatBody = document.getElementById("chatBody");
            let newMessage = document.createElement("div");
            newMessage.classList.add("chat-message");
            newMessage.innerHTML = `
                <div class="message-user">You</div>
                <div class="message-text">${messageText}</div>
                <div class="text-muted message-time" style="font-size: 0.8em;">${data.timestamp}</div>
            `;

            chatBody.appendChild(newMessage);
            chatBody.scrollTop = chatBody.scrollHeight;
            messageInput.value = "";
        }
    })
    .catch(error => {
        console.error("Error sending message:", error);
        alert("Failed to send message. Please try again.");
    });
});
</script>
</body>
</html>
